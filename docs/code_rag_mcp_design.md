# 代码RAG MCP模块 - 设计文档

## 概述
本文档概述了Model Context Protocol (MCP)模块的设计，该模块为IDE（如Cursor、VS Code等）提供代码检索功能。这种方法通过将检索与LLM处理分离，解决了本地计算资源不足的问题，允许IDE直接消费检索到的上下文。

## 问题陈述
- 本地LLM模型经常因计算资源不足而超时
- 当前Streamlit应用将检索和生成耦合在一起，难以扩展
- 开发人员需要在IDE中高效访问跨系统代码上下文
- 需要将检索与生成分离以获得更好的性能和灵活性

## 解决方案：代码检索的MCP模块

### 什么是MCP？
Model Context Protocol (MCP)是一个标准，允许工具向AI助手提供上下文信息。它使IDE能够按需请求和接收相关代码上下文。

### 架构
```
[IDE/Cursor] → [MCP服务器] → [代码RAG系统] → [Weaviate向量数据库]
     ↓              ↓              ↓
[上下文] ← [检索的代码] ← [搜索结果]
```

### 主要优势
1. **性能**：将计算密集型检索卸载到专用服务器
2. **IDE集成**：在开发环境中无缝访问上下文
3. **可扩展性**：可以处理多个并发请求
4. **灵活性**：可与任何LLM（本地或云端）一起使用
5. **缓存**：结果可以缓存以加快后续查询

## 实现计划

### 1. MCP服务器模块
- 使用Python实现MCP兼容服务器
- 支持用于上下文检索的标准MCP端点
- 处理身份验证和速率限制
- 提供多种输出格式（纯文本、JSON、markdown）

### 2. 检索端点
- `/search`: 使用查询进行通用代码搜索
- `/find-references`: 为特定函数/类查找代码引用
- `/find-definitions`: 为特定符号查找定义
- `/related-files`: 查找与当前上下文相关的文件

### 3. 输出格式
- **原始代码块**: 仅检索的代码片段
- **带注释**: 带有元数据的代码（文件路径、分数等）
- **摘要**: 检索上下文的简要摘要
- **结构化**: 带有完整元数据的JSON格式

### 4. IDE集成
- Cursor: MCP服务器集成
- VS Code: 使用MCP协议的扩展
- JetBrains: 支持MCP的插件
- Neovim/Emacs: MCP客户端插件

## 技术设计

### 依赖项
- `mcp`: Python MCP服务器库
- `llama-index`: 用于检索逻辑
- `weaviate-client`: 用于向量数据库访问
- `fastapi`: 用于HTTP端点（备用）
- `pydantic`: 用于数据验证

### 配置
- Weaviate连接设置
- 模型配置（用于嵌入）
- 速率限制设置
- 缓存配置
- 支持的文件类型和语言

### 安全考虑
- MCP访问的身份验证令牌
- 防止滥用的速率限制
- 代码访问权限
- 敏感代码过滤

## 与当前方法相比的优势

### 性能
- 检索在具有更好计算资源的专用服务器上发生
- 检索期间没有LLM处理开销
- 缓存减少重复查询
- 异步处理以获得更好的响应性

### 开发者体验
- 在IDE中直接可用上下文，无需切换工具
- 更快的相关代码片段访问
- 可与任何LLM一起使用（Ollama、OpenAI、Claude等）
- 代码更改时的实时上下文更新

### 可扩展性
- 可以同时处理多个开发人员
- 水平扩展可能
- 可以在云中部署以获得更好的性能
- 负载均衡以实现高可用性

## 实现步骤

### 第一阶段：基本MCP服务器
1. 设置MCP服务器基础设施
2. 实现基本搜索端点
3. 连接到现有的Weaviate数据库
4. 返回原始代码片段

### 第二阶段：增强功能
1. 添加文件类型过滤
2. 实现评分和排名
3. 添加缓存层
4. 支持多种查询类型

### 第三阶段：IDE集成
1. Cursor MCP集成
2. VS Code扩展
3. 文档和示例
4. 性能优化

### 第四阶段：高级功能
1. 跨仓库搜索
2. 语义相似性改进
3. 实时索引
4. 高级过滤选项

## 与现有系统的集成

### 非破坏性设计
- MCP模块独立于Streamlit应用运行
- 使用相同的Weaviate数据库和索引逻辑
- 对现有build_index.py无需更改
- 可以与当前Streamlit界面共存

### 共享组件
- 相同的嵌入模型和检索逻辑
- 相同的Weaviate模式和数据
- 相同的配置参数
- 可重用的检索函数

## 预期结果

### 短期
- 减少本地计算资源的负载
- 在IDE中更快的上下文检索
- 更好的开发人员生产力
- MCP集成的概念验证

### 长期
- 跨工具的标准上下文访问
- 改进的代码理解工作流程
- 高级功能的潜力（依赖分析等）
- 社区采用和扩展

## 风险和缓解措施

### 技术风险
- **网络延迟**: 将服务器部署在靠近开发环境的地方
- **安全性**: 实施适当的身份验证和访问控制
- **数据隐私**: 确保敏感代码得到适当保护

### 采用风险
- **IDE支持**: 首先关注流行的IDE（Cursor、VS Code）
- **学习曲线**: 提供清晰的文档和示例
- **性能**: 优化查询并实施缓存